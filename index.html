<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Loom</title>
    
    <meta property="og:title" content="The Loom of Existence">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß∂</text></svg>">

    <style>
        :root { --transition: all 0.2s ease; }

        /* --- THEMES --- */
        [data-theme="standard"] { --bg: #1e1e1e; --panel: #252526; --text: #d4d4d4; --high: #4fc1ff; --acc: #ce9178; --bord: #3e3e42; --font: 'Segoe UI', sans-serif; --btn: #333; }
        [data-theme="blueprint"] { --bg: #2b506e; --panel: #36648b; --text: #e0f0ff; --high: #fff; --acc: #aaddff; --bord: #5c8aae; --font: 'Courier New', monospace; --btn: #4682b4; }
        [data-theme="midnight"] { --bg: #0f172a; --panel: #1e293b; --text: #e2e8f0; --high: #818cf8; --acc: #38bdf8; --bord: #334155; --font: 'Verdana', sans-serif; --btn: #1e293b; }
        [data-theme="terminal"] { --bg: #1a1a1a; --panel: #000; --text: #ffb000; --high: #ffcc00; --acc: #ff9900; --bord: #664400; --font: 'VT323', monospace; --btn: #332200; }
        [data-theme="golden"] { --bg: #2c241b; --panel: #4a3b2a; --text: #fff8e1; --high: #ffd700; --acc: #ffecb3; --bord: #8a6e45; --font: 'Georgia', serif; --btn: #5c4d35; }
        [data-theme="nebula"] { --bg: #120b29; --panel: #241645; --text: #e0ccff; --high: #00ffff; --acc: #ff00ff; --bord: #482c8a; --font: 'Trebuchet MS', sans-serif; --btn: #351c6e; }

        body {
            background-color: var(--bg); color: var(--text); font-family: var(--font);
            margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            transition: var(--transition); user-select: none;
        }

        /* --- LAYOUT --- */
        #ticker-wrap { background: var(--panel); border-bottom: 1px solid var(--bord); height: 35px; overflow: hidden; display: flex; align-items: center; font-size: 0.9rem; flex-shrink: 0; }
        #ticker { display: inline-block; padding-left: 100%; animation: scroll 60s linear infinite; color: var(--high); font-weight: bold; white-space: nowrap; }
        @keyframes scroll { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        #app { display: grid; grid-template-rows: auto 1fr auto; height: 100%; max-width: 800px; margin: 0 auto; width: 100%; border-left: 1px solid var(--bord); border-right: 1px solid var(--bord); background: var(--bg); position: relative; }

        header { padding: 20px; text-align: center; border-bottom: 1px solid var(--bord); }
        .currency-display { font-size: 2.5rem; color: var(--high); font-weight: bold; line-height: 1; margin: 10px 0; }
        .silk-display { font-size: 1.2rem; color: #d8bfd8; margin-top: 5px; font-weight: bold; display:none;}
        
        .tab-content { overflow-y: auto; padding: 15px; display: none; height: 100%; box-sizing: border-box; }
        .tab-content.active { display: block; }

        nav { display: flex; border-top: 1px solid var(--bord); background: var(--panel); }
        .nav-btn { flex: 1; padding: 15px; background: none; border: none; color: var(--text); font-family: var(--font); font-weight: bold; cursor: pointer; opacity: 0.6; text-transform: uppercase; border-right: 1px solid var(--bord); position: relative; transition: all 0.3s; font-size: 0.8rem; }
        .nav-btn:hover { opacity: 1; background: rgba(255,255,255,0.05); }
        .nav-btn.active { opacity: 1; color: var(--high); border-top: 3px solid var(--high); background: var(--bg); }
        .nav-btn.special { color: #d8bfd8; } 
        
        .nav-btn.cat-tab { color: #ffa500; }
        .nav-btn.locked { opacity: 0.4; cursor: not-allowed; filter: grayscale(1); background: #110000; }

        .main-btn { width: 100%; padding: 20px; font-size: 1.1rem; background: var(--btn); color: var(--high); border: 2px solid var(--high); border-radius: 6px; cursor: pointer; font-family: var(--font); font-weight: bold; box-shadow: 0 4px 0 var(--bord); transition: transform 0.1s; margin-bottom: 20px; }
        .main-btn:active { transform: translateY(4px); box-shadow: none; }
        .main-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; filter: grayscale(1); }

        .card { background: var(--panel); border: 1px solid var(--bord); padding: 12px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; position: relative; }
        .card:hover { border-color: var(--high); }
        .card.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .card-info h4 { margin: 0; color: var(--text); }
        .card-info p { margin: 3px 0 0; font-size: 0.8rem; opacity: 0.7; }
        .card-meta { text-align: right; }
        .card-cost { color: var(--acc); font-weight: bold; font-size: 0.9rem; }
        .card-count { font-size: 1.2rem; color: var(--high); font-weight: bold; }

        .buy-controls { display: flex; justify-content: flex-end; margin-bottom: 10px; gap: 5px; }
        .buy-toggle { padding: 5px 10px; font-size: 0.8rem; background: var(--panel); border: 1px solid var(--bord); color: var(--text); cursor: pointer; }
        .buy-toggle.active { background: var(--high); color: var(--bg); border-color: var(--high); font-weight: bold; }

        /* --- THE TAPESTRY (TREE) --- */
        .tree-container { display: flex; flex-direction: column; align-items: center; padding-top: 10px; position: relative; padding-bottom: 50px; }
        .tree-row { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; position: relative; width: 100%; }
        .row-connector { text-align: center; color: var(--bord); font-size: 1.5rem; margin-top: -30px; margin-bottom: 10px; opacity: 0.5; }

        .tree-node {
            width: 90px; height: 90px; border-radius: 12px; border: 2px solid var(--bord);
            background: var(--panel); color: var(--text); display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; z-index: 2; transition: all 0.3s;
            box-shadow: 0 0 10px rgba(0,0,0,0.5); font-size: 0.8rem; text-align: center; padding: 5px;
        }
        .tree-node:hover { transform: scale(1.05); z-index: 10; }
        .tree-node.unlocked { border-color: #d8bfd8; color: #d8bfd8; box-shadow: 0 0 10px rgba(216, 191, 216, 0.2); }
        .tree-node.bought { background: #d8bfd8; color: #220022; border-color: #fff; box-shadow: 0 0 20px #d8bfd8; font-weight: bold; }
        .tree-node .node-name { font-weight: bold; margin-bottom: 4px; font-size: 0.85rem; }
        .tree-node .node-desc { font-size: 0.65rem; opacity: 0.8; line-height: 1.1; }
        .tree-node.bought .node-desc { opacity: 1; font-weight: normal; }
        .tree-node .node-cost { margin-top: 4px; font-size: 0.7rem; color: var(--acc); background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 4px;}
        .tree-node.bought .node-cost { display: none; }
        .tree-node.locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); }

        /* --- LOGIN & SYSTEM UI --- */
        .system-panel { background: rgba(0,0,0,0.2); border: 1px solid var(--bord); padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .system-header { color: var(--high); font-weight: bold; border-bottom: 1px solid var(--bord); padding-bottom: 5px; margin-bottom: 10px; display:flex; justify-content: space-between;}
        
        .login-box { display: flex; gap: 10px; margin-top: 10px; }
        .login-input { flex: 1; padding: 10px; background: var(--bg); border: 1px solid var(--bord); color: var(--text); border-radius: 4px; }
        .login-btn { padding: 10px 20px; background: var(--high); color: var(--bg); border: none; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .login-btn:hover { opacity: 0.9; }
        
        .logged-in-view { text-align: center; color: #00ff00; padding: 10px; border: 1px solid #004400; background: rgba(0,255,0,0.1); border-radius: 4px; }

        /* --- GOLDEN THREAD --- */
        #golden-thread {
            position: absolute; width: 30px; height: 30px; border-radius: 50%;
            background: radial-gradient(circle, #ffd700, #b8860b);
            box-shadow: 0 0 15px #ffd700; cursor: pointer; z-index: 999;
            display: none; animation: float 3s ease-in-out infinite;
        }
        @keyframes float { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* --- STATS & MISC --- */
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px dashed #333; padding-bottom: 2px; font-size:0.9rem;}
        
        .theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
        .theme-btn { padding: 10px; border: 1px solid var(--bord); background: var(--panel); color: var(--text); cursor: pointer; font-size: 0.8rem;}
        .theme-btn.locked { opacity: 0.5; cursor: not-allowed; background: #000; }
        
        .cat-container { text-align: center; border: 2px solid #ffa500; background: rgba(255, 165, 0, 0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .cat-eye { font-size: 4rem; animation: blink 4s infinite; display: inline-block; transform: scaleY(0.8); color: #ffa500; }
        @keyframes blink { 0%, 96%, 100% { transform: scaleY(0.8); } 98% { transform: scaleY(0.1); } }

        #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); pointer-events: none; z-index: 100; }
        .toast { background: var(--high); color: var(--bg); padding: 10px 20px; margin-top: 5px; border-radius: 4px; text-align: center; font-weight: bold; animation: slideUp 0.5s ease, fadeOut 0.5s 3s forwards; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; } }
        
        .save-controls { display:flex; gap:5px; margin-top:10px; }
        .save-btn { flex:1; padding:8px; cursor:pointer; background:var(--panel); border:1px solid var(--bord); color:var(--text); }
        .glow-btn { animation: glowPulse 2s infinite; border-color: #d8bfd8; box-shadow: 0 0 10px #d8bfd8; }
        @keyframes glowPulse { 0% { box-shadow: 0 0 5px #d8bfd8; } 50% { box-shadow: 0 0 20px #d8bfd8; } 100% { box-shadow: 0 0 5px #d8bfd8; } }
        
        .ach-grid { display: grid; grid-template-columns: 1fr; gap: 5px; max-height: 250px; overflow-y: auto; }
        .ach-item { border-bottom:1px solid #333; padding:5px; font-size: 0.9rem; }
        .ach-reward { font-size:0.7rem; opacity:0.7; margin-top: 2px; }
    </style>
</head>
<body data-theme="standard">

    <div id="ticker-wrap">
        <div id="ticker">System initialized... The Akashic Record awaits...</div>
    </div>
    
    <div id="golden-thread" onclick="clickGoldenThread()"></div>

    <div id="app">
        <header>
            <div class="currency-label">Universal Threads</div>
            <div class="currency-display" id="score">0</div>
            <div class="silk-display" id="silk-ui">‚úß <span id="silk-score">0</span> Silk ‚úß</div>
            <div class="mps-display" id="mps">0.0 per second</div>
        </header>

        <div id="tab-weave" class="tab-content active">
            <button class="main-btn" id="stitch-btn" onclick="clickAction()">WEAVE FABRIC <span style="font-size:0.8em; opacity:0.6;">(Space)</span></button>
            <div class="buy-controls">
                <button class="buy-toggle active" id="btn-x1" onclick="setBuyAmount(1)">x1</button>
                <button class="buy-toggle" id="btn-x10" onclick="setBuyAmount(10)">x10</button>
                <button class="buy-toggle" id="btn-x100" onclick="setBuyAmount(100)">x100</button>
            </div>
            <div id="generators-list"></div>
        </div>

        <div id="tab-research" class="tab-content">
            <h3 style="color:var(--high); border-bottom:1px solid var(--bord);">Pattern Research</h3>
            <div id="upgrades-list"></div>
        </div>

        <div id="tab-tapestry" class="tab-content">
            <div class="prestige-header" style="text-align:center; margin-bottom:20px; border-bottom:1px solid var(--bord); padding-bottom:10px;">
                <h3 style="color:#d8bfd8; margin:0;">THE TAPESTRY</h3>
                <p style="font-size:0.8rem; color:#a0a0a0;">Evolve the structure of reality.</p>
                <div style="font-size:1.2rem; margin:10px 0;">Available Silk: <span id="tree-silk" style="color:#d8bfd8; font-weight:bold;">0</span></div>
                
                <div style="font-size:0.9rem; margin-top:5px;">Prestige Pending: <span id="pending-silk" style="color:#fff;">0</span> Silk</div>
                <div id="void-warning" style="color:orange; font-size:0.8rem; margin-bottom:5px;">Unravel at 1M Threads</div>
                <button id="void-btn" class="main-btn" style="padding:10px; font-size:1rem; border-color:#d8bfd8; color:#d8bfd8; background:#2a0a2a; margin-bottom:0;" onclick="prestige()">UNRAVEL (RESET)</button>
            </div>
            
            <div class="tree-container" id="skill-tree"></div>
        </div>

        <div id="tab-cat" class="tab-content">
            <div class="cat-container">
                <div class="cat-eye">‚óé ‚óé</div>
                <div id="cat-text" class="cat-dialogue">"I require the ball of yarn. All of it."</div>
                <div style="margin-bottom:10px; font-size: 0.9rem; color: #ffcc00;">
                    Current C.A.T. Level: <span id="cat-level-display">0</span><br>
                    Bonus: <span id="cat-bonus-display">1x</span> Multiplier
                </div>
                <button class="main-btn" id="cat-btn" style="border-color:#ffa500; color:#ffa500; background: #332200;" onclick="feedCat()">
                    SACRIFICE EVERYTHING<br>
                    <span style="font-size:0.7rem">Req: 1 Billion Threads. Reward: +1x Multiplier & 100 Silk.</span>
                </button>
            </div>
        </div>

        <div id="tab-settings" class="tab-content">
            
            <div class="system-panel">
                <div class="system-header">
                    <span>The Akashic Record</span>
                    <span id="login-status-indicator" style="font-size:0.8rem; color:gray;">Offline</span>
                </div>
                
                <div id="login-form">
                    <p style="font-size:0.85rem; opacity:0.8;">Register your identity to sync with the Universal Loom. <br><strong>Reward: +500 Silk</strong></p>
                    <div class="login-box">
                        <input type="email" id="email-input" class="login-input" placeholder="Enter Email Address..." />
                        <button class="login-btn" onclick="login()">Connect</button>
                    </div>
                </div>

                <div id="logged-in-display" style="display:none;" class="logged-in-view">
                    <div>Identity Verified: <span id="user-email" style="font-weight:bold; color:#fff;"></span></div>
                    <div style="font-size:0.8rem; opacity:0.7; margin-top:5px;">Connection Active. Progress Saved.</div>
                </div>
            </div>

            <div class="system-panel">
                <div class="system-header">Statistics</div>
                <div class="stats-row"><span>Lifetime Threads:</span> <span id="stat-lifetime" style="color:#fff">0</span></div>
                <div class="stats-row"><span>Manual Clicks:</span> <span id="stat-clicks">0</span></div>
                <div class="stats-row"><span>Play Time:</span> <span id="stat-time">0m</span></div>
                <div class="stats-row"><span>Achievements:</span> <span id="stat-ach">0</span></div>
            </div>

            <div class="system-panel">
                <div class="system-header">Data Management</div>
                <div class="save-controls">
                    <button class="save-btn" onclick="saveGame(); showToast('Saved')">Save Local</button>
                    <button class="save-btn" onclick="exportSave()">Export Code</button>
                    <button class="save-btn" onclick="importSave()">Import Code</button>
                    <button class="save-btn" onclick="hardReset()" style="color:red; border-color:red;">Wipe</button>
                </div>
            </div>

            <h3 style="color:var(--high)">Achievements</h3>
            <div id="achievements-list" class="ach-grid"></div>
            
            <h3 style="color:var(--high); margin-top:20px;">Themes</h3>
            <div class="theme-grid" id="theme-selector">
                <button class="theme-btn" onclick="setTheme('standard')">Standard</button>
                <button class="theme-btn" onclick="setTheme('blueprint')">Blueprint</button>
                <button class="theme-btn" onclick="setTheme('midnight')">Midnight</button>
                <button class="theme-btn" onclick="setTheme('terminal')">Terminal</button>
                <button class="theme-btn" onclick="setTheme('matrix')">Matrix</button>
                <button class="theme-btn" onclick="setTheme('cotton')">Cotton</button>
                <button class="theme-btn" onclick="setTheme('contrast')">Contrast</button>
                <button class="theme-btn" onclick="setTheme('nebula')" style="border:1px solid #a0f;">Nebula</button>
                <button class="theme-btn" id="theme-btn-golden" onclick="setTheme('golden')">GOLDEN</button>
            </div>
        </div>

        <nav>
            <button class="nav-btn active" onclick="switchTab('weave', this)">Weave</button>
            <button class="nav-btn" onclick="switchTab('research', this)">Research</button>
            <button class="nav-btn special" onclick="switchTab('tapestry', this)">Tapestry</button>
            <button class="nav-btn cat-tab locked" id="nav-cat" onclick="switchTab('cat', this)">C.A.T.</button>
            <button class="nav-btn" onclick="switchTab('settings', this)">System</button>
        </nav>
    </div>
    <div id="toast-container"></div>

    <script>
        /* --- GAME DATA V4.1 --- */
        let buyAmount = 1;
        const gameData = {
            threads: 0, totalThreads: 0, lifetimeTotal: 0, silk: 0, clicks: 0,
            startTime: Date.now(), theme: 'standard',
            catLevel: 0,
            account: { email: "", loggedIn: false }, // NEW for Login
            generators: [
                { id: 0, name: "Lint Roller", baseCost: 15, mps: 0.5, count: 0 },
                { id: 1, name: "Grandma's Needle", baseCost: 100, mps: 4, count: 0 },
                { id: 2, name: "Spider Drone", baseCost: 1100, mps: 16, count: 0 },
                { id: 3, name: "Quantum Loom", baseCost: 12000, mps: 60, count: 0 },
                { id: 4, name: "Timeline Splicer", baseCost: 130000, mps: 250, count: 0 },
                { id: 5, name: "Big Bang Forge", baseCost: 1500000, mps: 1000, count: 0 },
                { id: 6, name: "Reality Engine", baseCost: 15000000, mps: 5000, count: 0 },
                { id: 7, name: "Black Hole Weaver", baseCost: 250000000, mps: 25000, count: 0 },
                { id: 8, name: "Hyper-String Guitar", baseCost: 5000000000, mps: 120000, count: 0 },
                { id: 9, name: "The Narrative Device", baseCost: 99000000000, mps: 600000, count: 0 }
            ],
            upgrades: [
                { id: 0, name: "Thimble", cost: 250, type: "click", mult: 2, bought: false, desc: "Click x2" },
                { id: 1, name: "Caffeine", cost: 1000, type: "gen", gId: 0, mult: 2, bought: false, desc: "Roller x2" },
                { id: 2, name: "Steel Wool", cost: 5000, type: "click", mult: 2, bought: false, desc: "Click x2" },
                { id: 3, name: "Neon Thread", cost: 15000, type: "gen", gId: 1, mult: 2, bought: false, desc: "Needle x2" },
                { id: 4, name: "The Algorithm", cost: 200000, type: "global", mult: 1.2, bought: false, desc: "Global +20%" },
                { id: 5, name: "Flux Capacitor", cost: 25000000, type: "gen", gId: 6, mult: 2, bought: false, desc: "Engine x2" },
                { id: 6, name: "Quantum Entanglement", cost: 500000, type: "synergy", from: 0, to: 4, mult: 0.01, bought: false, desc: "Rollers boost Splicers" },
                { id: 7, name: "Event Horizon", cost: 1000000000, type: "gen", gId: 7, mult: 3, bought: false, desc: "Black Hole x3" },
                { id: 8, name: "Resonance", cost: 25000000000, type: "gen", gId: 8, mult: 2, bought: false, desc: "Guitars x2" },
                { id: 9, name: "Author's Note", cost: 500000000000, type: "gen", gId: 9, mult: 2, bought: false, desc: "Narrative x2" }
            ],
            tree: [
                { id: 0, row: 1, name: "Origin Knot", cost: 5, bought: false, parent: null, desc: "+50% Global MPS" },
                { id: 1, row: 2, name: "Golden Eye", cost: 15, bought: false, parent: 0, desc: "Golden Threads x2 Freq" },
                { id: 2, row: 2, name: "Efficiency", cost: 15, bought: false, parent: 0, desc: "-10% All Costs" },
                { id: 3, row: 3, name: "Tension", cost: 50, bought: false, parent: 1, desc: "Click gets +1% MPS" },
                { id: 4, row: 3, name: "Synergy", cost: 50, bought: false, parent: 2, desc: "+2% MPS per Achievement" },
                { id: 5, row: 4, name: "Passive Silk", cost: 150, bought: false, parent: 3, desc: "Generate Silk over time" },
                { id: 6, row: 4, name: "Deep Pockets", cost: 100, bought: false, parent: 2, desc: "Start runs with 2500 Threads" },
                { id: 7, row: 4, name: "Chronos", cost: 100, bought: false, parent: 4, desc: "+10% MPS per Hour Played" },
                { id: 8, row: 5, name: "Ascension", cost: 500, bought: false, parent: 7, desc: "Global MPS x3" }
            ],
            achievements: [
                { id: "a1", name: "First Stitch", req: 100, type: "total", unlocked: false, reward: "+1 Click", rewardDesc: "+1 Base Click" },
                { id: "a2", name: "Master Weaver", req: 100000, type: "total", unlocked: false, reward: "+5% MPS", rewardDesc: "+5% Global MPS" },
                { id: "a3", name: "Ascended", req: 1, type: "silk", unlocked: false, reward: "+10% Silk", rewardDesc: "Silk +10% (Fake visual)" },
                { id: "a4", name: "Hoarder", req: 1000000, type: "current", unlocked: false, reward: "-1% Cost", rewardDesc: "-1% Costs" },
                { id: "a5", name: "Cat Servant", req: 1, type: "cat", unlocked: false, reward: "Respect", rewardDesc: "The Cat tolerates you" },
                { id: "a6", name: "Curiosity", req: 1, type: "punish", unlocked: false, reward: "Shame", rewardDesc: "Learned a lesson" },
                { id: "a7", name: "Completionist", req: 20, type: "count", unlocked: false, reward: "Theme", rewardDesc: "Gold Theme" },
                { id: "a8", name: "Speed Demon", req: 1000000, type: "mps", unlocked: false, reward: "+5% MPS", rewardDesc: "+5% Global MPS" },
                { id: "a9", name: "Finger Workout", req: 5000, type: "clicks", unlocked: false, reward: "+2 Click", rewardDesc: "+2 Base Click" },
                { id: "a10", name: "Architect", req: 500, type: "buildings", unlocked: false, reward: "-2% Cost", rewardDesc: "-2% Building Cost" },
                { id: "a11", name: "Millionaire", req: 1000000, type: "silk", unlocked: false, reward: "+10% MPS", rewardDesc: "+10% Global MPS" },
                { id: "a12", name: "Clicking Frenzy", req: 10000, type: "clicks", unlocked: false, reward: "+5 Click", rewardDesc: "+5 Base Click" },
                { id: "a13", name: "Time Lord", req: 60, type: "time", unlocked: false, reward: "-1% Cost", rewardDesc: "-1% Costs" },
                { id: "a14", name: "Billionaire", req: 1000000000, type: "total", unlocked: false, reward: "+5% MPS", rewardDesc: "+5% MPS" },
                { id: "a15", name: "Trillionaire", req: 1000000000000, type: "total", unlocked: false, reward: "+5% MPS", rewardDesc: "+5% MPS" },
                { id: "a16", name: "Carpal Tunnel", req: 25000, type: "clicks", unlocked: false, reward: "+10 Click", rewardDesc: "+10 Base Click" },
                { id: "a17", name: "Nebula", req: 5, type: "tree", unlocked: false, reward: "Theme", rewardDesc: "Nebula Theme" },
                { id: "a18", name: "Dedicated", req: 300, type: "time", unlocked: false, reward: "-2% Cost", rewardDesc: "-2% Costs (5hrs)" },
                { id: "a19", name: "Black Hole", req: 1, type: "gen8", unlocked: false, reward: "Dense", rewardDesc: "Unlock Narratives" },
                { id: "a20", name: "Infinity", req: 1000000000000000, type: "total", unlocked: false, reward: "Ego", rewardDesc: "You are the Loom" },
                // NEW V4.1
                { id: "a21", name: "Registered Soul", req: 1, type: "login", unlocked: false, reward: "Verified", rewardDesc: "+500 Silk Reward" }
            ]
        };

        const tickerMessages = [
            "Weaving space-time...", "Don't pull the loose thread.", 
            "Local spider files copyright claim.", "Error 404: Universe not found.",
            "Updating the matrix...", "The Reality Engine hums.",
            "Golden Threads spotted in the wild.", "Buying in bulk saves time!",
            "The Tapestry expands...", "Knot theory applied to shoelaces.",
            "Dark matter is just accumulated lint.", "String Theory confirmed: It is E-String.",
            "The C.A.T. is napping on the server.", "Warning: Narrative device overheating.",
            "Who writes the achievements? You do.", "Infinite monkeys typing infinite code...",
            "Your finger must be tired.", "Sponsor: wormholes-r-us.",
            "Is the universe a hologram or a knitting project?", "Buffering reality...",
            "Connecting to Akashic Records..."
        ];

        /* --- ENGINE --- */
        function getCost(base, count, amount) {
            let discount = 1;
            if(gameData.tree[2].bought) discount *= 0.9;
            if(gameData.achievements.find(a=>a.id==='a4' && a.unlocked)) discount *= 0.99; 
            if(gameData.achievements.find(a=>a.id==='a10' && a.unlocked)) discount *= 0.98;
            if(gameData.achievements.find(a=>a.id==='a13' && a.unlocked)) discount *= 0.99;
            if(gameData.achievements.find(a=>a.id==='a18' && a.unlocked)) discount *= 0.98;

            const r = 1.15;
            let totalCost = 0;
            if(amount === 1) {
                totalCost = Math.floor(base * Math.pow(r, count));
            } else {
                totalCost = Math.floor(base * ((Math.pow(r, amount) - 1) / (r - 1)) * Math.pow(r, count));
            }
            return Math.floor(totalCost * discount);
        }

        function getMPS() {
            let mps = 0;
            let globalMult = 1;
            gameData.upgrades.filter(u=>u.bought && u.type==='global').forEach(u => globalMult *= u.mult);
            
            // Tree Bonuses
            if(gameData.tree[0].bought) globalMult *= 1.5;
            if(gameData.tree[7].bought) {
                const hours = (Date.now() - gameData.startTime) / 3600000;
                globalMult *= (1 + (hours * 0.1));
            }
            if(gameData.tree[4].bought) {
                const count = gameData.achievements.filter(a => a.unlocked).length;
                globalMult *= (1 + (count * 0.02));
            }
            if(gameData.tree[8].bought) globalMult *= 3;

            globalMult *= (1 + gameData.catLevel);
            if(gameData.achievements.find(a=>a.id==='a2' && a.unlocked)) globalMult *= 1.05; 
            if(gameData.achievements.find(a=>a.id==='a8' && a.unlocked)) globalMult *= 1.05; 
            if(gameData.achievements.find(a=>a.id==='a11' && a.unlocked)) globalMult *= 1.10;
            if(gameData.achievements.find(a=>a.id==='a14' && a.unlocked)) globalMult *= 1.05;
            if(gameData.achievements.find(a=>a.id==='a15' && a.unlocked)) globalMult *= 1.05;

            gameData.generators.forEach(g => {
                let mult = 1;
                gameData.upgrades.filter(u=>u.bought && u.type==='gen' && u.gId===g.id).forEach(u => mult *= u.mult);
                if(g.id === 4 && gameData.upgrades[6].bought) {
                    const rollerCount = gameData.generators[0].count;
                    mult *= (1 + (rollerCount * 0.01));
                }
                mps += (g.mps * g.count * mult);
            });
            return mps * globalMult;
        }

        function getClickPower() {
            let power = 1;
            if(gameData.achievements.find(a=>a.id==='a1' && a.unlocked)) power += 1;
            if(gameData.achievements.find(a=>a.id==='a9' && a.unlocked)) power += 2;
            if(gameData.achievements.find(a=>a.id==='a12' && a.unlocked)) power += 5;
            if(gameData.achievements.find(a=>a.id==='a16' && a.unlocked)) power += 10;
            
            gameData.upgrades.filter(u=>u.bought && u.type==='click').forEach(u => power *= u.mult);
            
            let mpsPercent = 0.03;
            if(gameData.tree[3].bought) mpsPercent += 0.01;
            
            power += (getMPS() * mpsPercent); 
            return power;
        }

        /* --- ACTIONS --- */
        function clickAction() {
            const amt = getClickPower();
            gameData.threads += amt;
            gameData.totalThreads += amt;
            gameData.lifetimeTotal += amt;
            gameData.clicks++;
            updateUI();
        }

        function setBuyAmount(amt) {
            buyAmount = amt;
            document.querySelectorAll('.buy-toggle').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-x'+amt).classList.add('active');
            updateUI();
        }

        function buyGenerator(id) {
            const g = gameData.generators[id];
            const cost = getCost(g.baseCost, g.count, buyAmount);
            if(gameData.threads >= cost) {
                gameData.threads -= cost;
                g.count += buyAmount;
                updateUI();
            }
        }

        function buyUpgrade(id) {
            const u = gameData.upgrades[id];
            if(!u.bought && gameData.threads >= u.cost) {
                gameData.threads -= u.cost;
                u.bought = true;
                updateUI();
            }
        }

        /* --- LOGIN SYSTEM (V4.1) --- */
        function login() {
            const emailInput = document.getElementById('email-input');
            const email = emailInput.value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (emailRegex.test(email)) {
                // Simulate Login
                gameData.account.email = email;
                gameData.account.loggedIn = true;
                
                // Reward
                gameData.silk += 500;
                
                // Check Achievement
                const ach = gameData.achievements.find(a => a.id === 'a21');
                if(!ach.unlocked) {
                    ach.unlocked = true;
                    showToast("üèÜ Account Linked! +500 Silk");
                } else {
                    showToast("Welcome back!");
                }
                
                saveGame();
                updateUI();
            } else {
                showToast("Invalid Email Format");
                emailInput.style.borderColor = "red";
            }
        }

        /* --- TREE SYSTEM --- */
        function buyTreeNode(id) {
            const node = gameData.tree.find(n => n.id === id);
            if(!node || node.bought) return;
            
            if(node.parent !== null && !gameData.tree.find(n=>n.id === node.parent).bought) {
                showToast("Unlock previous node first.");
                return;
            }

            if(gameData.silk >= node.cost) {
                gameData.silk -= node.cost;
                node.bought = true;
                updateUI();
                showToast(`Unlocked: ${node.name}`);
            } else {
                showToast("Not enough Silk.");
            }
        }

        function renderTree() {
            const container = document.getElementById('skill-tree');
            container.innerHTML = "";
            const rows = [1, 2, 3, 4, 5];
            rows.forEach(rNum => {
                const nodesInRow = gameData.tree.filter(n => n.row === rNum);
                if(nodesInRow.length > 0) {
                    if(rNum > 1) {
                         const conn = document.createElement('div');
                         conn.className = 'row-connector';
                         conn.innerHTML = "‚Üì";
                         container.appendChild(conn);
                    }
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'tree-row';
                    
                    nodesInRow.forEach(node => {
                        const el = document.createElement('div');
                        el.className = 'tree-node';
                        let parentBought = (node.parent === null) ? true : gameData.tree.find(n=>n.id === node.parent).bought;
                        if(node.bought) el.classList.add('bought');
                        else if (parentBought) el.classList.add('unlocked');
                        else el.classList.add('locked');
                        
                        el.onclick = () => buyTreeNode(node.id);
                        el.innerHTML = `<div class="node-name">${node.bought ? '‚úî ' + node.name : node.name}</div>
                            <div class="node-desc">${node.desc}</div><div class="node-cost">${node.cost} Silk</div>`;
                        rowDiv.appendChild(el);
                    });
                    container.appendChild(rowDiv);
                }
            });
        }

        /* --- PRESTIGE --- */
        function prestige() {
            if(gameData.totalThreads < 1000000) return;
            let pending = Math.floor(Math.sqrt(gameData.totalThreads / 1000000));
            if(!confirm(`Unravel? +${pending} Silk`)) return;

            gameData.silk += pending;
            resetRun();
            showToast(`Unraveled! +${pending} Silk`);
        }

        function resetRun() {
            gameData.threads = gameData.tree[6].bought ? 2500 : 0;
            gameData.totalThreads = 0;
            gameData.generators.forEach(g => g.count = 0);
            gameData.upgrades.forEach(u => u.bought = false);
            updateUI();
        }

        /* --- GOLDEN THREAD --- */
        function spawnGoldenThread() {
            const el = document.getElementById('golden-thread');
            if(el.style.display === 'block') return;

            const app = document.getElementById('app');
            const rect = app.getBoundingClientRect();
            const top = Math.random() * (rect.height - 100) + 50;
            const left = Math.random() * (rect.width - 100) + 50;
            
            el.style.top = top + "px";
            el.style.left = left + "px";
            el.style.display = 'block';

            setTimeout(() => { if(el.style.display === 'block') el.style.display = 'none'; }, 10000);
        }

        function clickGoldenThread() {
            const el = document.getElementById('golden-thread');
            el.style.display = 'none';
            const mps = getMPS();
            const bonus = Math.max(1000, mps * 300);
            gameData.threads += bonus;
            gameData.totalThreads += bonus;
            gameData.lifetimeTotal += bonus;
            showToast(`Golden Thread! +${format(bonus)}`);
            updateUI();
        }

        /* --- CAT --- */
        function feedCat() {
            if(gameData.threads < 1000000000) { showToast("The C.A.T. demands 1 Billion Threads."); return; }
            if(!confirm("Sacrifice ALL Threads?")) return;
            gameData.catLevel++;
            gameData.silk += 100;
            const ach = gameData.achievements.find(a => a.id === 'a5');
            if(!ach.unlocked) { ach.unlocked = true; showToast("üèÜ Cat Servant"); }
            resetRun();
        }

        /* --- UTILS --- */
        function format(num) {
            if(num < 1000) return Math.floor(num);
            if(num < 1000000) return (num/1000).toFixed(2) + "k";
            if(num < 1000000000) return (num/1000000).toFixed(2) + "M";
            if(num < 1000000000000) return (num/1000000000).toFixed(2) + "B";
            if(num < 1000000000000000) return (num/1000000000000).toFixed(2) + "T";
            if(num < 1000000000000000000) return (num/1000000000000000).toFixed(2) + "q";
            if(num < 1000000000000000000000) return (num/1000000000000000000).toFixed(2) + "Q";
            return "Inf";
        }

        function showToast(msg) {
            const con = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast'; el.innerText = msg;
            con.appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }

        function setTheme(name) {
            if(name === 'golden' && gameData.achievements.filter(a => a.unlocked).length < 20) { showToast("Locked: Need 20 Achievements"); return; }
            if(name === 'nebula' && !gameData.achievements.find(a=>a.id==='a17').unlocked) { showToast("Locked: Need 5 Skills"); return; }
            document.body.setAttribute('data-theme', name);
            gameData.theme = name;
        }

        function switchTab(id, btn) {
            if(btn.classList.contains('locked')) {
                const pct = Math.floor((gameData.lifetimeTotal / 100000000) * 100);
                showToast(`Locked. Progress: ${pct}% / 100%`); return;
            }
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(id === 'tapestry') renderTree();
        }

        /* --- SAVE/LOAD --- */
        function saveGame() { localStorage.setItem('loomSaveV41', JSON.stringify(gameData)); }
        function loadGame() {
            let save = JSON.parse(localStorage.getItem('loomSaveV41'));
            if(!save) save = JSON.parse(localStorage.getItem('loomSaveV40')); // Migrating from v4.0

            if(save) {
                if(save.threads !== undefined) gameData.threads = save.threads;
                if(save.totalThreads !== undefined) gameData.totalThreads = save.totalThreads;
                if(save.lifetimeTotal !== undefined) gameData.lifetimeTotal = save.lifetimeTotal;
                if(save.silk !== undefined) gameData.silk = save.silk;
                if(save.clicks !== undefined) gameData.clicks = save.clicks;
                if(save.startTime) gameData.startTime = save.startTime;
                if(save.theme) setTheme(save.theme);
                if(save.catLevel) gameData.catLevel = save.catLevel;
                if(save.account) gameData.account = save.account; // Load account data

                if(save.generators) save.generators.forEach((g,i) => { if(gameData.generators[i]) gameData.generators[i].count = g.count; });
                if(save.upgrades) save.upgrades.forEach((u,i) => { if(gameData.upgrades[i]) gameData.upgrades[i].bought = u.bought; });
                if(save.tree) save.tree.forEach(t => { const match = gameData.tree.find(n => n.id === t.id); if(match) match.bought = t.bought; });
                if(save.achievements) save.achievements.forEach((a,i) => { if(gameData.achievements[i]) gameData.achievements[i].unlocked = a.unlocked; });
            }
        }
        function hardReset() { if(confirm("Wipe EVERYTHING?")) { localStorage.removeItem('loomSaveV41'); location.reload(); } }
        function exportSave() {
            const str = btoa(JSON.stringify(gameData));
            navigator.clipboard.writeText(str).then(() => showToast("Save Copied!"));
        }
        function importSave() {
            const str = prompt("Paste Save:");
            if(!str) return;
            try {
                const json = atob(str);
                const data = JSON.parse(json);
                localStorage.setItem('loomSaveV41', JSON.stringify(data));
                location.reload();
            } catch(e) { alert("Invalid"); }
        }

        function checkAchievements() {
            gameData.achievements.forEach(a => {
                if(!a.unlocked) {
                    let u = false;
                    if(a.type === 'total' && gameData.lifetimeTotal >= a.req) u = true;
                    if(a.type === 'current' && gameData.threads >= a.req) u = true;
                    if(a.type === 'silk' && gameData.silk >= a.req) u = true;
                    if(a.type === 'cat' && gameData.catLevel >= a.req) u = true;
                    if(a.type === 'count' && gameData.achievements.filter(ach=>ach.unlocked).length >= a.req) u = true;
                    if(a.type === 'mps' && getMPS() >= a.req) u = true;
                    if(a.type === 'clicks' && gameData.clicks >= a.req) u = true;
                    if(a.type === 'buildings' && gameData.generators.reduce((acc, v) => acc + v.count, 0) >= a.req) u = true;
                    if(a.type === 'time' && (Date.now()-gameData.startTime)/60000 >= a.req) u = true;
                    if(a.type === 'tree' && gameData.tree.filter(n=>n.bought).length >= a.req) u = true;
                    if(a.type === 'gen8' && gameData.generators[7].count >= a.req) u = true;
                    if(a.type === 'login' && gameData.account.loggedIn) u = true;

                    if(u) { a.unlocked = true; showToast(`üèÜ ${a.name}`); updateUI(); }
                }
            });
        }

        function updateUI() {
            document.getElementById('score').innerText = format(gameData.threads);
            document.getElementById('mps').innerText = format(getMPS()) + " / sec";
            document.getElementById('silk-score').innerText = gameData.silk;
            document.getElementById('tree-silk').innerText = gameData.silk;
            
            // Login UI
            if(gameData.account && gameData.account.loggedIn) {
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('logged-in-display').style.display = 'block';
                document.getElementById('user-email').innerText = gameData.account.email;
                document.getElementById('login-status-indicator').innerText = "Online";
                document.getElementById('login-status-indicator').style.color = "#0f0";
            } else {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('logged-in-display').style.display = 'none';
                document.getElementById('login-status-indicator').innerText = "Offline";
                document.getElementById('login-status-indicator').style.color = "gray";
            }

            // Stats
            document.getElementById('stat-lifetime').innerText = format(gameData.lifetimeTotal);
            document.getElementById('stat-clicks').innerText = gameData.clicks;
            document.getElementById('stat-time').innerText = Math.floor((Date.now() - gameData.startTime) / 60000) + "m";
            document.getElementById('stat-ach').innerText = gameData.achievements.filter(a=>a.unlocked).length + " / " + gameData.achievements.length;

            // Prestige UI
            let pending = 0;
            const voidBtn = document.getElementById('void-btn');
            if(gameData.totalThreads >= 1000000) {
                pending = Math.floor(Math.sqrt(gameData.totalThreads / 1000000));
                voidBtn.disabled = false; voidBtn.classList.add('glow-btn'); voidBtn.style.opacity = 1;
                document.getElementById('void-warning').style.display = 'none';
            } else {
                voidBtn.disabled = true; voidBtn.classList.remove('glow-btn'); voidBtn.style.opacity = 0.5;
                document.getElementById('void-warning').style.display = 'block';
            }
            document.getElementById('pending-silk').innerText = pending;
            if(gameData.silk > 0 || gameData.lifetimeTotal > 1000000) document.getElementById('silk-ui').style.display = 'block';

            // CAT Lock
            const catBtn = document.getElementById('nav-cat');
            if(gameData.lifetimeTotal < 100000000) catBtn.classList.add('locked'); else catBtn.classList.remove('locked');
            document.getElementById('cat-level-display').innerText = gameData.catLevel;
            document.getElementById('cat-bonus-display').innerText = (1 + gameData.catLevel) + "x";
            document.getElementById('cat-btn').disabled = (gameData.threads < 1000000000);

            // Lists
            const gList = document.getElementById('generators-list');
            gList.innerHTML = "";
            gameData.generators.forEach(g => {
                const cost = getCost(g.baseCost, g.count, buyAmount);
                const can = gameData.threads >= cost;
                gList.innerHTML += `<div class="card ${can?'':'disabled'}" onclick="buyGenerator(${g.id})">
                    <div class="card-info"><h4>${g.name}</h4></div>
                    <div class="card-meta"><div class="card-count">${g.count}</div><div class="card-cost">${format(cost)}</div></div></div>`;
            });

            const uList = document.getElementById('upgrades-list');
            uList.innerHTML = "";
            gameData.upgrades.forEach(u => {
                if(!u.bought) {
                    const can = gameData.threads >= u.cost;
                    uList.innerHTML += `<div class="card ${can?'':'disabled'}" onclick="buyUpgrade(${u.id})">
                        <div class="card-info"><h4>${u.name}</h4><p>${u.desc}</p></div><div class="card-meta"><div class="card-cost">${format(u.cost)}</div></div></div>`;
                }
            });
            if(uList.innerHTML === "") uList.innerHTML = "<div style='text-align:center; opacity:0.5;'>Research complete.</div>";

            const aList = document.getElementById('achievements-list');
            aList.innerHTML = "";
            gameData.achievements.forEach(a => {
                aList.innerHTML += `<div class="ach-item" style="${a.unlocked?"color:var(--high); font-weight:bold;":"opacity:0.5;"}">
                    ${a.unlocked?"‚úî":"üîí"} ${a.name} <div class="ach-reward">Reward: ${a.rewardDesc}</div></div>`;
            });
            
            // Theme Locks
            const gBtn = document.getElementById('theme-btn-golden');
            if(gameData.achievements.filter(a => a.unlocked).length < 20) gBtn.classList.add('locked'); else gBtn.classList.remove('locked');
            
            if(document.getElementById('tab-tapestry').classList.contains('active')) renderTree();
        }

        setInterval(() => {
            const mps = getMPS();
            if(mps > 0) {
                const tick = mps / 10;
                gameData.threads += tick;
                gameData.totalThreads += tick;
                gameData.lifetimeTotal += tick;
            }
            checkAchievements();
            updateUI();
        }, 100);

        // Passive Silk Generation (Faster now)
        setInterval(() => {
            if(gameData.tree[5].bought) {
                gameData.silk++;
                showToast("+1 Silk (Passive)");
            }
        }, 45000); // Changed from 60000 to 45000

        setInterval(() => { saveGame(); }, 30000);
        setInterval(() => { document.getElementById('ticker').innerText = tickerMessages[Math.floor(Math.random()*tickerMessages.length)]; }, 15000);

        function scheduleGoldenThread() {
            let minTime = 60000;
            if(gameData.tree[1].bought) minTime = 30000;
            const time = Math.random() * minTime + minTime;
            setTimeout(() => { spawnGoldenThread(); scheduleGoldenThread(); }, time);
        }

        loadGame();
        updateUI();
        scheduleGoldenThread();
    </script>
</body>
</html>
