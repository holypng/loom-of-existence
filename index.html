<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Loom v6.1: Restored</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ§¶</text></svg>">

    <style>
        :root { --transition: all 0.2s ease; }

        /* --- RESTORED THEMES (Cleaner Colors) --- */
        [data-theme="standard"] { --bg: #1a1a1a; --panel: #222; --text: #eee; --high: #fff; --acc: #888; --bord: #333; --font: 'Segoe UI', sans-serif; --btn: #1a1a1a; --highlight-color: #d8bfd8; }
        [data-theme="blueprint"] { --bg: #2b506e; --panel: #36648b; --text: #e0f0ff; --high: #fff; --acc: #aaddff; --bord: #5c8aae; --font: 'Courier New', monospace; --btn: #4682b4; --highlight-color: #aaddff; }
        
        body {
            background-color: var(--bg); color: var(--text); font-family: var(--font);
            margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            transition: var(--transition); user-select: none;
        }

        /* --- LAYOUT RESTORATION --- */
        #ticker-wrap { background: var(--panel); border-bottom: 1px solid var(--bord); height: 30px; display: flex; align-items: center; font-size: 0.8rem; flex-shrink: 0; opacity: 0.7; }
        #ticker { display: inline-block; padding-left: 100%; animation: scroll 45s linear infinite; color: var(--high); white-space: nowrap; }
        @keyframes scroll { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        #app { display: grid; grid-template-rows: auto 1fr auto; height: 100%; max-width: 800px; margin: 0 auto; width: 100%; border-left: 1px solid var(--bord); border-right: 1px solid var(--bord); background: var(--bg); position: relative; }

        /* Cleaner Header - No clutter */
        header { padding: 25px; text-align: center; border-bottom: 1px solid var(--bord); background: var(--bg); }
        .currency-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0.5; margin-bottom: 5px; }
        .currency-display { font-size: 3rem; color: var(--high); font-weight: 300; line-height: 1; margin: 0; font-variant-numeric: tabular-nums; }
        .mps-display { font-size: 0.9rem; color: var(--acc); margin-top: 8px; font-variant-numeric: tabular-nums; }
        
        .tab-content { overflow-y: auto; padding: 20px; display: none; height: 100%; box-sizing: border-box; }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Cleaner Nav - Text based again */
        nav { display: flex; border-top: 1px solid var(--bord); background: var(--panel); overflow-x: auto; scrollbar-width: none; }
        nav::-webkit-scrollbar { display: none; }
        .nav-btn { flex: 1; min-width: 80px; padding: 15px; background: none; border: none; color: var(--text); font-family: var(--font); cursor: pointer; opacity: 0.5; text-transform: uppercase; border-right: 1px solid var(--bord); font-size: 0.75rem; letter-spacing: 1px; transition: all 0.2s; }
        .nav-btn:hover { opacity: 1; background: rgba(255,255,255,0.03); }
        .nav-btn.active { opacity: 1; color: var(--high); background: var(--bg); border-top: 3px solid var(--highlight-color); font-weight: bold; }
        .nav-btn.locked { opacity: 0.2; pointer-events: none; }

        /* --- UI COMPONENTS --- */
        .main-btn { width: 100%; padding: 20px; font-size: 1.1rem; background: transparent; color: var(--high); border: 1px solid var(--bord); border-radius: 4px; cursor: pointer; font-family: var(--font); transition: all 0.1s; margin-bottom: 20px; letter-spacing: 1px; text-transform: uppercase; }
        .main-btn:hover { border-color: var(--high); background: rgba(255,255,255,0.02); }
        .main-btn:active { transform: scale(0.99); }
        .main-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; border-color: var(--bord); }

        .section-header { border-bottom: 1px solid var(--bord); padding-bottom: 10px; margin-bottom: 15px; color: var(--highlight-color); font-weight: normal; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; }

        /* Generator Cards - Restored to clean look */
        .card { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--bord); cursor: pointer; transition: background 0.2s; }
        .card:first-child { border-top: 1px solid var(--bord); }
        .card:hover { background: rgba(255,255,255,0.03); }
        .card.disabled { opacity: 0.4; pointer-events: none; }
        .card-info h4 { margin: 0; font-weight: normal; font-size: 1rem; color: var(--text); }
        .card-info p { margin: 4px 0 0; font-size: 0.8rem; color: var(--acc); }
        .card-meta { text-align: right; }
        .card-cost { color: var(--acc); font-size: 0.85rem; }
        .card-count { font-size: 1.2rem; color: var(--high); margin-bottom: 2px; }

        .buy-controls { display: flex; justify-content: center; margin-bottom: 20px; gap: 10px; }
        .buy-toggle { background: transparent; border: 1px solid var(--bord); color: var(--acc); padding: 5px 15px; cursor: pointer; border-radius: 20px; font-size: 0.8rem; }
        .buy-toggle.active { border-color: var(--high); color: var(--high); background: rgba(255,255,255,0.05); }

        /* --- ARTIFACTS (Cleaner Grid) --- */
        .artifact-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .artifact-slot { border: 1px solid var(--bord); padding: 15px; border-radius: 4px; text-align: left; cursor: pointer; position: relative; min-height: 80px; display: flex; align-items: center; gap: 10px; transition: border 0.2s; }
        .artifact-slot:hover { border-color: var(--high); }
        .artifact-slot.equipped { border-color: #ffd700; background: rgba(255, 215, 0, 0.05); }
        .art-icon { font-size: 1.5rem; }
        .art-info div { font-size: 0.9rem; font-weight: bold; color: var(--text); }
        .art-info span { font-size: 0.75rem; color: var(--acc); display: block; }
        .art-status { position: absolute; top: 5px; right: 5px; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; color: #ffd700; display: none; }
        .artifact-slot.equipped .art-status { display: block; }

        /* --- DYE VAT (Table style) --- */
        .vat-display { display: flex; justify-content: space-around; padding: 20px; background: rgba(255,255,255,0.02); margin-bottom: 20px; border-radius: 4px; }
        .vat-col { text-align: center; }
        .vat-val { font-size: 1.5rem; font-weight: bold; }
        .vat-label { font-size: 0.7rem; text-transform: uppercase; opacity: 0.7; }
        
        .dye-list { display: flex; flex-direction: column; gap: 10px; }
        .dye-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid var(--bord); }
        .dye-btn { background: transparent; border: 1px solid var(--bord); color: var(--text); padding: 8px 15px; cursor: pointer; font-size: 0.8rem; min-width: 100px; }
        .dye-btn:hover { border-color: var(--high); }

        /* --- MONOLITH --- */
        .challenge-card { border: 1px solid var(--bord); padding: 15px; margin-bottom: 15px; opacity: 0.7; transition: opacity 0.2s; }
        .challenge-card:hover { opacity: 1; border-color: var(--acc); }
        .challenge-card.active { border-color: #ff4444; opacity: 1; border-left: 4px solid #ff4444; }
        .challenge-card.completed { border-left: 4px solid #44ff44; opacity: 0.5; }

        /* --- UTILS --- */
        #toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); pointer-events: none; z-index: 100; text-align: center; width: 100%; }
        .toast { display: inline-block; background: var(--high); color: var(--bg); padding: 8px 16px; margin-top: 5px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; animation: fadeUp 3s forwards; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        @keyframes fadeUp { 0% { opacity: 0; transform: translateY(10px); } 10% { opacity: 1; transform: translateY(0); } 90% { opacity: 1; } 100% { opacity: 0; transform: translateY(-10px); } }

        /* Golden Thread */
        #golden-thread {
            position: absolute; width: 20px; height: 20px; border-radius: 50%;
            background: #ffd700; box-shadow: 0 0 10px #ffd700; cursor: pointer; z-index: 999;
            display: none; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.3); opacity: 1; } 100% { transform: scale(1); opacity: 0.8; } }
    </style>
</head>
<body data-theme="standard">

    <div id="ticker-wrap">
        <div id="ticker">System initialized... Reality restored...</div>
    </div>
    
    <div id="golden-thread" onclick="clickGoldenThread()"></div>

    <div id="app">
        <header>
            <div class="currency-label">Universal Threads</div>
            <div class="currency-display" id="score">0</div>
            <div class="mps-display" id="mps">0.0 / sec</div>
        </header>

        <div id="tab-weave" class="tab-content active">
            <button class="main-btn" onclick="clickAction()">Weave Fabric</button>
            
            <div class="buy-controls">
                <button class="buy-toggle active" id="btn-x1" onclick="setBuyAmount(1)">1</button>
                <button class="buy-toggle" id="btn-x10" onclick="setBuyAmount(10)">10</button>
                <button class="buy-toggle" id="btn-x100" onclick="setBuyAmount(100)">100</button>
            </div>

            <div id="generators-list"></div>
        </div>

        <div id="tab-research" class="tab-content">
            <h3 class="section-header">Research</h3>
            <div id="upgrades-list"></div>
        </div>

        <div id="tab-vault" class="tab-content">
            <h3 class="section-header">Artifact Vault <span style="font-size:0.8rem; opacity:0.5" id="art-count">0/8</span></h3>
            <div class="artifact-grid" id="artifact-list">
                <div style="grid-column: span 2; text-align: center; padding: 40px; opacity: 0.5; font-style: italic;">
                    Artifacts are found randomly while weaving...
                </div>
            </div>
        </div>

        <div id="tab-dye" class="tab-content">
            <h3 class="section-header">The Dye Vat</h3>
            
            <div class="vat-display">
                <div class="vat-col" style="color:#ff6b6b">
                    <div class="vat-val" id="val-red">0</div>
                    <div class="vat-label">Red (Speed)</div>
                </div>
                <div class="vat-col" style="color:#4fc1ff">
                    <div class="vat-val" id="val-blue">0</div>
                    <div class="vat-label">Blue (Cost)</div>
                </div>
                <div class="vat-col" style="color:#6bff84">
                    <div class="vat-val" id="val-green">0</div>
                    <div class="vat-label">Green (Luck)</div>
                </div>
            </div>

            <div class="dye-list">
                <div class="dye-item">
                    <div>
                        <div style="color:#ff6b6b; font-weight:bold;">Red Dye</div>
                        <div style="font-size:0.8rem; opacity:0.7">Boil threads for efficiency (+10% MPS)</div>
                    </div>
                    <button class="dye-btn" onclick="buyDye('red')">Mix</button>
                </div>
                <div class="dye-item">
                    <div>
                        <div style="color:#4fc1ff; font-weight:bold;">Blue Dye</div>
                        <div style="font-size:0.8rem; opacity:0.7">Lubricate the loom (-Cost)</div>
                    </div>
                    <button class="dye-btn" onclick="buyDye('blue')">Mix</button>
                </div>
                <div class="dye-item">
                    <div>
                        <div style="color:#6bff84; font-weight:bold;">Green Dye</div>
                        <div style="font-size:0.8rem; opacity:0.7">Attract anomalies (+Luck)</div>
                    </div>
                    <button class="dye-btn" onclick="buyDye('green')">Mix</button>
                </div>
            </div>
        </div>

        <div id="tab-tapestry" class="tab-content">
            <h3 class="section-header">The Tapestry <span style="font-size:0.8rem; color:#d8bfd8" id="tree-silk">0 Silk</span></h3>
            <div style="text-align:center; margin-bottom:20px; font-size:0.9rem; opacity:0.7;">
                Prestige Pending: <span id="pending-silk" style="color:#fff; font-weight:bold;">0</span> Silk
            </div>
            <button class="main-btn" id="void-btn" onclick="prestige()" style="border-color:#d8bfd8; color:#d8bfd8">Unravel Reality (Reset)</button>
            <div class="tree-container" id="skill-tree" style="margin-top:20px; display:flex; flex-direction:column; align-items:center; gap:20px;"></div>
        </div>

        <div id="tab-monolith" class="tab-content">
            <h3 class="section-header">The Monolith</h3>
            <p style="font-size:0.8rem; opacity:0.7; margin-bottom:20px;">Enter simulations with strict rules to unlock permanent Runes.</p>
            <div id="active-chal-ui" style="display:none; padding:15px; border:1px solid #ff4444; color:#ff4444; text-align:center; margin-bottom:20px;">
                <strong>âš  SIMULATION ACTIVE âš </strong><br>
                <button class="dye-btn" onclick="exitChallenge()" style="margin-top:10px; border-color:#ff4444; color:#ff4444;">ABORT</button>
            </div>
            <div id="challenge-list"></div>
        </div>

        <div id="tab-settings" class="tab-content">
            <h3 class="section-header">System</h3>
            <button class="main-btn" onclick="saveGame(); showToast('Saved')">Save Data</button>
            <button class="main-btn" onclick="hardReset()" style="border-color:#ff4444; color:#ff4444;">Wipe Data</button>
            
            <h3 class="section-header" style="margin-top:30px;">Themes</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="buy-toggle" onclick="setTheme('standard')">Standard</button>
                <button class="buy-toggle" onclick="setTheme('blueprint')">Blueprint</button>
            </div>
            
            <div id="stats-area" style="margin-top:30px; font-size:0.8rem; opacity:0.5; font-family:monospace;"></div>
        </div>

        <nav>
            <button class="nav-btn active" onclick="switchTab('weave', this)">Weave</button>
            <button class="nav-btn" onclick="switchTab('research', this)">Research</button>
            <button class="nav-btn" onclick="switchTab('vault', this)">Vault</button>
            <button class="nav-btn locked" id="nav-dye" onclick="switchTab('dye', this)">Vat</button>
            <button class="nav-btn locked" id="nav-tree" onclick="switchTab('tapestry', this)">Tree</button>
            <button class="nav-btn locked" id="nav-mono" onclick="switchTab('monolith', this)">Mono</button>
            <button class="nav-btn" onclick="switchTab('settings', this)">Sys</button>
        </nav>
    </div>
    <div id="toast-container"></div>

    <script>
        /* --- GAME LOGIC (V6.1) --- */
        let buyAmount = 1;
        const artifactDB = [
            { id: "art_rust", name: "Rusty Scissors", desc: "+25% Click, -10% Auto", type: "mixed", bonus: "click", val: 0.25, pen: "mps", penVal: 0.9, icon: "âœ‚ï¸" },
            { id: "art_thimble", name: "Lucky Thimble", desc: "+50% Click Power", type: "buff", bonus: "click", val: 0.5, icon: "ðŸ¥¡" },
            { id: "art_oil", name: "Machine Oil", desc: "+20% Auto Speed", type: "buff", bonus: "mps", val: 0.2, icon: "ðŸ›¢ï¸" },
            { id: "art_glass", name: "Magnifying Glass", desc: "-5% Costs", type: "buff", bonus: "cost", val: 0.95, icon: "ðŸ”" },
            { id: "art_knot", name: "Impossible Knot", desc: "+100% Auto, No Clicks", type: "mixed", bonus: "mps", val: 1.0, pen: "click", penVal: 0, icon: "ðŸ¥¨" },
            { id: "art_coin", name: "Ancient Coin", desc: "+50% Luck", type: "buff", bonus: "luck", val: 0.5, icon: "ðŸª™" },
            { id: "art_needle", name: "Diamond Needle", desc: "Click x3", type: "buff", bonus: "click", val: 2.0, icon: "ðŸ’Ž" },
            { id: "art_cube", name: "Void Cube", desc: "-10% Costs", type: "buff", bonus: "cost", val: 0.9, icon: "â¬›" }
        ];

        const challengeDB = [
            { id: "c1", name: "The Purist", desc: "Reach 5k Threads. CLICKS ONLY. No Generators.", reward: "+50% Click Power", goal: 5000 },
            { id: "c2", name: "The Observer", desc: "Reach 10k Threads. NO CLICKS. Generators only.", reward: "+20% Passive MPS", goal: 10000 },
            { id: "c3", name: "The Drought", desc: "Reach 50k Threads. Costs scale +50% faster.", reward: "-5% Global Costs", goal: 50000 }
        ];

        let gameData = {
            threads: 0, totalThreads: 0, lifetimeTotal: 0, silk: 0, clicks: 0,
            startTime: Date.now(), theme: 'standard',
            dyes: { red: 0, blue: 0, green: 0 },
            artifacts: [], 
            activeChallenge: null, completedChallenges: [],
            generators: [
                { id: 0, name: "Lint Roller", baseCost: 15, mps: 0.5, count: 0 },
                { id: 1, name: "Grandma's Needle", baseCost: 100, mps: 4, count: 0 },
                { id: 2, name: "Spider Drone", baseCost: 1100, mps: 16, count: 0 },
                { id: 3, name: "Quantum Loom", baseCost: 12000, mps: 60, count: 0 },
                { id: 4, name: "Timeline Splicer", baseCost: 130000, mps: 250, count: 0 },
                { id: 5, name: "Big Bang Forge", baseCost: 1500000, mps: 1000, count: 0 },
                { id: 6, name: "Reality Engine", baseCost: 15000000, mps: 5000, count: 0 },
                { id: 7, name: "Black Hole Weaver", baseCost: 250000000, mps: 25000, count: 0 }
            ],
            upgrades: [
                { id: 0, name: "Thimble", cost: 250, type: "click", mult: 2, bought: false, desc: "Click x2" },
                { id: 1, name: "Caffeine", cost: 1000, type: "gen", gId: 0, mult: 2, bought: false, desc: "Roller x2" },
                { id: 2, name: "Steel Wool", cost: 5000, type: "click", mult: 2, bought: false, desc: "Click x2" },
                { id: 3, name: "Neon Thread", cost: 15000, type: "gen", gId: 1, mult: 2, bought: false, desc: "Needle x2" },
                { id: 4, name: "The Algorithm", cost: 200000, type: "global", mult: 1.2, bought: false, desc: "Global +20%" },
                { id: 5, name: "Flux Capacitor", cost: 25000000, type: "gen", gId: 6, mult: 2, bought: false, desc: "Engine x2" }
            ],
            tree: [
                { id: 0, row: 1, name: "Origin Knot", cost: 5, bought: false, parent: null, desc: "+50% Global MPS" },
                { id: 1, row: 2, name: "Golden Eye", cost: 15, bought: false, parent: 0, desc: "More Golden Threads" },
                { id: 2, row: 2, name: "Efficiency", cost: 15, bought: false, parent: 0, desc: "-10% All Costs" },
                { id: 3, row: 3, name: "Starter Kit", cost: 50, bought: false, parent: 2, desc: "Start runs with 500 Threads" },
                { id: 4, row: 3, name: "Deep Pockets", cost: 100, bought: false, parent: 2, desc: "+1% MPS per Artifact found" },
                { id: 5, row: 4, name: "Ascension", cost: 500, bought: false, parent: 3, desc: "Global MPS x3" }
            ]
        };

        /* CORE */
        function getCost(base, count, amount) {
            let discount = 1;
            if(gameData.tree[2].bought) discount *= 0.9;
            discount *= (1 - (Math.min(50, gameData.dyes.blue * 2) / 100));
            getEquippedArtifacts().forEach(a => { if(a.bonus === 'cost') discount *= a.val; });
            if(gameData.completedChallenges.includes('c3')) discount *= 0.95;

            const r = (gameData.activeChallenge === 'c3') ? 1.5 : 1.15;
            let total = 0;
            if(amount === 1) total = Math.floor(base * Math.pow(r, count));
            else total = Math.floor(base * ((Math.pow(r, amount) - 1) / (r - 1)) * Math.pow(r, count));
            
            return Math.floor(total * discount);
        }

        function getMPS() {
            let mps = 0;
            let globalMult = 1;
            gameData.upgrades.filter(u=>u.bought && u.type==='global').forEach(u => globalMult *= u.mult);
            if(gameData.tree[0].bought) globalMult *= 1.5;
            if(gameData.tree[5].bought) globalMult *= 3;
            if(gameData.tree[4].bought) globalMult *= (1 + (gameData.artifacts.length * 0.01));
            globalMult *= (1 + (gameData.dyes.red * 0.1));
            if(gameData.completedChallenges.includes('c2')) globalMult *= 1.2;

            getEquippedArtifacts().forEach(a => {
                if(a.bonus === 'mps') globalMult *= (1 + a.val);
                if(a.pen === 'mps') globalMult *= a.penVal;
            });

            gameData.generators.forEach(g => {
                let mult = 1;
                gameData.upgrades.filter(u=>u.bought && u.type==='gen' && u.gId===g.id).forEach(u => mult *= u.mult);
                mps += (g.mps * g.count * mult);
            });
            return mps * globalMult;
        }

        function getClickPower() {
            if(gameData.activeChallenge === 'c2') return 0;
            let power = 1;
            getEquippedArtifacts().forEach(a => {
                if(a.bonus === 'click') power += (getMPS() * a.val) + 1;
                if(a.pen === 'click') power = 0;
            });
            if(power === 0) return 0;
            gameData.upgrades.filter(u=>u.bought && u.type==='click').forEach(u => power *= u.mult);
            if(gameData.completedChallenges.includes('c1')) power *= 1.5;
            power += (getMPS() * 0.05); 
            return power;
        }

        /* ACTIONS */
        function clickAction() {
            const amt = getClickPower();
            if(amt <= 0) { showToast("Clicks Disabled"); return; }
            addThreads(amt);
            gameData.clicks++;
            let luck = 1 + (gameData.dyes.green * 0.05);
            getEquippedArtifacts().forEach(a => { if(a.bonus === 'luck') luck += a.val; });
            if(Math.random() < (0.001 * luck)) findArtifact();
            updateUI();
        }

        function addThreads(n) {
            gameData.threads += n; gameData.totalThreads += n; gameData.lifetimeTotal += n;
            if(gameData.activeChallenge) checkChal();
        }

        function buyGenerator(id) {
            if(gameData.activeChallenge === 'c1') { showToast("No Generators in Challenge"); return; }
            const g = gameData.generators[id];
            const cost = getCost(g.baseCost, g.count, buyAmount);
            if(gameData.threads >= cost) { gameData.threads -= cost; g.count += buyAmount; updateUI(); }
        }

        function buyUpgrade(id) {
            const u = gameData.upgrades[id];
            if(!u.bought && gameData.threads >= u.cost) { gameData.threads -= u.cost; u.bought = true; updateUI(); }
        }

        function buyDye(type) {
            const cost = 10000 * Math.pow(5, gameData.dyes[type]);
            if(gameData.threads >= cost) { gameData.threads -= cost; gameData.dyes[type]++; updateUI(); showToast("Mixed Dye"); }
            else showToast(`Need ${format(cost)}`);
        }

        function setBuyAmount(n) { buyAmount = n; document.querySelectorAll('.buy-toggle').forEach(b=>b.classList.remove('active')); document.getElementById('btn-x'+n).classList.add('active'); updateUI(); }

        /* ARTIFACTS */
        function findArtifact() {
            const owned = gameData.artifacts.map(a=>a.id);
            const pool = artifactDB.filter(a=>!owned.includes(a.id));
            if(pool.length === 0) { gameData.threads += getMPS()*60; showToast("Found Threads"); return; }
            const found = pool[Math.floor(Math.random()*pool.length)];
            gameData.artifacts.push({ id: found.id, equipped: false });
            showToast(`Found: ${found.name}`);
            renderArtifacts();
        }
        function getEquippedArtifacts() { return gameData.artifacts.filter(a=>a.equipped).map(a=>artifactDB.find(d=>d.id===a.id)); }
        function toggleArtifact(id) {
            const a = gameData.artifacts.find(x=>x.id===id);
            if(a.equipped) a.equipped = false;
            else if(gameData.artifacts.filter(x=>x.equipped).length < 2) a.equipped = true;
            else { showToast("Max 2 Equipped"); return; }
            renderArtifacts(); updateUI();
        }
        function renderArtifacts() {
            const grid = document.getElementById('artifact-list');
            grid.innerHTML = "";
            gameData.artifacts.forEach(a => {
                const db = artifactDB.find(d=>d.id===a.id);
                grid.innerHTML += `<div class="artifact-slot ${a.equipped?'equipped':''}" onclick="toggleArtifact('${a.id}')">
                    <div class="art-status">EQUIPPED</div>
                    <div class="art-icon">${db.icon}</div>
                    <div class="art-info"><div>${db.name}</div><span>${db.desc}</span></div>
                </div>`;
            });
            document.getElementById('art-count').innerText = `${gameData.artifacts.length}/${artifactDB.length}`;
        }

        /* CHALLENGES */
        function enterChallenge(id) { if(confirm("Start Simulation? (Resets run)")) { gameData.activeChallenge = id; prestige(true); switchTab('weave', document.querySelector('.nav-btn')); } }
        function exitChallenge() { if(confirm("Abort?")) { gameData.activeChallenge = null; prestige(true); } }
        function checkChal() {
            const c = challengeDB.find(x=>x.id===gameData.activeChallenge);
            if(gameData.threads >= c.goal) { alert(`Simulation Complete. Unlocked: ${c.reward}`); gameData.completedChallenges.push(c.id); gameData.activeChallenge = null; prestige(true); }
        }

        /* TREE & PRESTIGE */
        function prestige(force=false) {
            if(!force && gameData.totalThreads < 1000000) return;
            if(!force) {
                const pending = Math.floor(Math.sqrt(gameData.totalThreads/1000000));
                if(!confirm(`Unravel? +${pending} Silk`)) return;
                gameData.silk += pending;
            }
            gameData.threads = gameData.tree[3].bought ? 500 : 0;
            gameData.totalThreads = 0;
            gameData.generators.forEach(g=>g.count=0);
            gameData.upgrades.forEach(u=>u.bought=false);
            updateUI(); saveGame();
        }
        function buyTreeNode(id) {
            const n = gameData.tree.find(x=>x.id===id);
            if(!n || n.bought || (n.parent!==null && !gameData.tree.find(x=>x.id===n.parent).bought)) return;
            if(gameData.silk >= n.cost) { gameData.silk -= n.cost; n.bought = true; renderTree(); updateUI(); }
        }
        function renderTree() {
            const el = document.getElementById('skill-tree');
            el.innerHTML = "";
            gameData.tree.forEach(n => {
                const pBought = n.parent===null || gameData.tree.find(x=>x.id===n.parent).bought;
                el.innerHTML += `<div style="padding:10px; border:1px solid #555; width:200px; text-align:center; cursor:pointer; background:${n.bought?'#d8bfd8':'#222'}; color:${n.bought?'#000':'#fff'}; opacity:${pBought?1:0.3}" onclick="buyTreeNode(${n.id})">
                    <b>${n.name}</b><br><span style="font-size:0.7rem">${n.desc}</span><br>${n.bought?'Owned':n.cost+' Silk'}
                </div>`;
            });
        }

        /* UTILS */
        function format(n) {
            if(n<1000) return Math.floor(n);
            if(n<1000000) return (n/1000).toFixed(2)+"k";
            if(n<1000000000) return (n/1000000).toFixed(2)+"M";
            return (n/1000000000).toFixed(2)+"B";
        }
        function showToast(msg) {
            const el = document.createElement('div'); el.className='toast'; el.innerText=msg;
            document.getElementById('toast-container').appendChild(el);
            setTimeout(()=>el.remove(),3000);
        }
        function switchTab(id, btn) {
            if(btn.classList.contains('locked')) return;
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            if(id==='vault') renderArtifacts();
            if(id==='tapestry') renderTree();
            if(id==='monolith') renderChallenges();
        }
        function renderChallenges() {
            const el = document.getElementById('challenge-list'); el.innerHTML = "";
            challengeDB.forEach(c => {
                const act = gameData.activeChallenge === c.id;
                const comp = gameData.completedChallenges.includes(c.id);
                el.innerHTML += `<div class="challenge-card ${act?'active':''} ${comp?'completed':''}">
                    <div style="font-weight:bold; color:#fff">${c.name} ${comp?'(DONE)':''}</div>
                    <div style="font-size:0.8rem; color:#aaa; margin:5px 0">${c.desc}</div>
                    <div style="font-size:0.8rem; color:var(--highlight-color)">Reward: ${c.reward}</div>
                    ${!act && !comp ? `<button class="main-btn" style="margin-top:10px; padding:5px; font-size:0.8rem" onclick="enterChallenge('${c.id}')">Start</button>` : ''}
                </div>`;
            });
        }
        function setTheme(t) { document.body.setAttribute('data-theme', t); gameData.theme = t; }

        /* GOLDEN THREAD */
        function spawnGoldenThread() {
            const el = document.getElementById('golden-thread');
            const app = document.getElementById('app');
            el.style.top = (Math.random()*(app.offsetHeight-40)+20)+"px";
            el.style.left = (Math.random()*(app.offsetWidth-40)+10)+"px";
            el.style.display = 'block';
            setTimeout(()=>{ if(el.style.display==='block') el.style.display='none'; }, 6000);
        }
        function clickGoldenThread() {
            document.getElementById('golden-thread').style.display='none';
            let amt = Math.max(500, getMPS()*60);
            addThreads(amt); showToast("Golden Thread!");
            if(Math.random() < 0.05) findArtifact();
        }

        /* LOOP & SAVE */
        function updateUI() {
            document.getElementById('score').innerText = format(gameData.threads);
            document.getElementById('mps').innerText = format(getMPS()) + " / sec";
            
            // Unlocks
            if(gameData.lifetimeTotal > 10000) document.getElementById('nav-tree').classList.remove('locked');
            if(gameData.lifetimeTotal > 100000) document.getElementById('nav-dye').classList.remove('locked');
            if(gameData.lifetimeTotal > 500000) document.getElementById('nav-mono').classList.remove('locked');

            // Generator List
            const gList = document.getElementById('generators-list');
            if(gList.innerHTML === "") {
                gameData.generators.forEach(g => {
                    gList.innerHTML += `<div class="card" id="gen-${g.id}" onclick="buyGenerator(${g.id})">
                        <div class="card-info"><h4>${g.name}</h4><p>+${g.mps} mps</p></div>
                        <div class="card-meta"><div class="card-count" id="g-count-${g.id}">0</div><div class="card-cost" id="g-cost-${g.id}">0</div></div>
                    </div>`;
                });
            }
            gameData.generators.forEach(g => {
                const c = getCost(g.baseCost, g.count, buyAmount);
                document.getElementById(`gen-${g.id}`).className = `card ${gameData.threads>=c?'':'disabled'}`;
                document.getElementById(`g-count-${g.id}`).innerText = g.count;
                document.getElementById(`g-cost-${g.id}`).innerText = format(c);
            });

            // Upgrades
            const uList = document.getElementById('upgrades-list');
            uList.innerHTML = "";
            gameData.upgrades.filter(u=>!u.bought).forEach(u => {
                uList.innerHTML += `<div class="card ${gameData.threads>=u.cost?'':'disabled'}" onclick="buyUpgrade(${u.id})">
                    <div class="card-info"><h4>${u.name}</h4><p>${u.desc}</p></div><div class="card-meta"><div class="card-cost">${format(u.cost)}</div></div>
                </div>`;
            });
            if(uList.innerHTML==="") uList.innerHTML="<div style='text-align:center; opacity:0.5; padding:20px'>Research Complete</div>";

            // Dyes & Silk
            document.getElementById('val-red').innerText = gameData.dyes.red;
            document.getElementById('val-blue').innerText = gameData.dyes.blue;
            document.getElementById('val-green').innerText = gameData.dyes.green;
            document.getElementById('tree-silk').innerText = gameData.silk + " Silk";
            document.getElementById('pending-silk').innerText = Math.floor(Math.sqrt(gameData.totalThreads/1000000));
            document.getElementById('void-btn').disabled = gameData.totalThreads < 1000000;

            // Challenge Active UI
            document.getElementById('active-chal-ui').style.display = gameData.activeChallenge ? 'block' : 'none';
            document.getElementById('stats-area').innerHTML = `Time: ${Math.floor((Date.now()-gameData.startTime)/60000)}m | Ver: 6.1`;
        }

        setInterval(() => { if(getMPS()>0) addThreads(getMPS()/10); updateUI(); }, 100);
        setInterval(() => saveGame(), 15000);
        (function loopG(){ setTimeout(()=>{ spawnGoldenThread(); loopG(); }, Math.random()*30000+20000); })();
        
        function saveGame() { localStorage.setItem('loomSaveV6_1', JSON.stringify(gameData)); }
        function loadGame() {
            let s = JSON.parse(localStorage.getItem('loomSaveV6_1'));
            if(!s) s = JSON.parse(localStorage.getItem('loomSaveV6'));
            if(s) {
                gameData = {...gameData, ...s}; 
                // fix array merges
                if(s.generators) s.generators.forEach((g,i)=>gameData.generators[i].count=g.count);
                if(s.upgrades) s.upgrades.forEach((u,i)=>gameData.upgrades[i].bought=u.bought);
                if(s.tree) s.tree.forEach(t=>{const m=gameData.tree.find(n=>n.id===t.id); if(m) m.bought=t.bought;});
                if(s.artifacts) gameData.artifacts = s.artifacts;
                setTheme(gameData.theme);
            }
        }
        function hardReset() { if(confirm("Wipe?")) { localStorage.removeItem('loomSaveV6_1'); location.reload(); } }
        
        loadGame();
        updateUI();
    </script>
</body>
</html>
